---
interface Props {
  compact?: boolean;
}

const { compact = false } = Astro.props;
---

<div class:list={['newsletter-signup', { 'newsletter-signup--compact': compact }]}>
  {!compact && <h2>Tilmeld nyhedsbrev</h2>}
  <p>Modtag besked om kommende foredrag og arrangementer direkte i din indbakke.</p>

  <form class="newsletter-form" id="newsletter-form">
    <div class="form-row">
      <label for="newsletter-email" class="sr-only">E-mailadresse</label>
      <input
        type="email"
        id="newsletter-email"
        name="email"
        placeholder="Din e-mailadresse"
        required
        class="form-input"
      />
      <button type="submit" class="btn btn--primary newsletter-btn">Tilmeld</button>
    </div>
    <div class="newsletter-message" id="newsletter-message" aria-live="polite"></div>
  </form>
</div>

<script>
  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const message = document.getElementById('newsletter-message')!;

  // Scroll-animation
  const signup = form.closest('.newsletter-signup')!;
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        signup.classList.add('is-visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });
  observer.observe(signup);

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    message.textContent = '';
    message.className = 'newsletter-message';

    const email = (form.querySelector('[name="email"]') as HTMLInputElement).value;

    try {
      const res = await fetch('/api/subscribe', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      const data = await res.json();
      if (res.ok) {
        message.textContent = 'Tak for din tilmelding!';
        message.classList.add('newsletter-message--success');
        form.reset();
      } else {
        message.textContent = data.error || 'Der opstod en fejl.';
        message.classList.add('newsletter-message--error');
      }
    } catch {
      message.textContent = 'Kunne ikke oprette forbindelse. Pr√∏v igen.';
      message.classList.add('newsletter-message--error');
    }
  });
</script>

<style>
  .newsletter-signup {
    max-width: 480px;
    margin: 0 auto;
    text-align: center;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.6s ease, transform 0.6s ease;
  }

  .newsletter-signup.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  .newsletter-signup h2 {
    margin-bottom: var(--space-xs);
  }

  .newsletter-signup p {
    margin-bottom: var(--space-md);
    color: var(--color-text-muted);
  }

  .newsletter-signup--compact p {
    margin-bottom: var(--space-sm);
  }

  .form-row {
    display: flex;
    gap: 0.5rem;
  }

  .form-input {
    flex: 1;
    padding: 0.7rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: 6px;
    font-size: var(--text-sm);
    font-family: var(--font-sans);
    background: var(--color-white);
    color: var(--color-text);
    transition: border-color 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .newsletter-btn {
    flex-shrink: 0;
  }

  .newsletter-message {
    margin-top: var(--space-sm);
    font-size: var(--text-sm);
    min-height: 1.5em;
  }

  .newsletter-message--success {
    color: var(--color-olive);
  }

  .newsletter-message--error {
    color: #b91c1c;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (max-width: 480px) {
    .form-row {
      flex-direction: column;
    }
  }
</style>
